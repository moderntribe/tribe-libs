name: Monorepo Release

on:
  push:
    tags:
      - '*'

jobs:
  list-repos:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          coverage: none

      - name: Checkout
        uses: actions/checkout@v2

      - uses: ramsey/composer-install@v2

      - name: Set repo matrix
        id: set-matrix
        run: echo "::set-output name=matrix::$(./monorepo.sh packages-json --exclude-package easy-coding-standard --exclude-package monorepo-builder --exclude-package config-transformer --exclude-package easy-ci --exclude-package vendor-patches --exclude-package phpstan-rules)"

  split:
    needs: list-repos
    runs-on: ubuntu-latest
    env:
      # This should be changed based on the branch where this action lives to match
      # the versions that will be released, so for a "4.x" branch would be 4.0.0 <= 5.0.0.
      # Branches MUST EXIST in the sub-repos for this to work, so use the
      # sub-repo-branch-create.yml GitHub action to create those branches first.
      # If you branch from this, ensure to change the split_branch to a new major version!
      split_branch: '4.x'
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.list-repos.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v2

      - # Uses an action in the root directory
        name: Monorepo Tagged Split of ${{ matrix.package }}
        uses: symplify/github-action-monorepo-split@2.0
        env:
          GITHUB_TOKEN: ${{ secrets.TR1B0T_TRIBE_LIBS_MONOREPO_TOKEN }}
        with:
          tag: ${GITHUB_REF#refs/tags/}

          package-directory: 'src/${{ matrix.package }}'
          split-repository-organization: 'moderntribe'
          split-repository-name: '${{ matrix.package }}'
          user-name: 'Tr1b0t'
          user-email: 'Tr1b0t@users.noreply.github.com'
          branch: '${{ env.split_branch }}'

